<div class="flex lg:flex-row flex-col lg:items-center justify-between mb-4 w-full gap-6">
    <div class="flex-1">
        <div class="label-medium">Serveurs</div>
        <span class="mt-1 body-xsmall">Liste des serveurs actifs de BastionMC</span>
    </div>
    <div class="flex flex-wrap items-center gap-3.5">
        <p-select
            *ngIf="!minigameFilter"
            [options]="minigameFilters"
            [(ngModel)]="selectedMinigameFilter"
            placeholder="Tous les mini-jeux"
            styleClass="w-48"
            optionLabel="label"
            optionValue="value"
            (onChange)="onFilterChange()"
        ></p-select>
        <p-icon-field>
            <p-inputicon class="pi pi-search"/>
            <input pInputText class="!rounded-lg !py-1.5 !w-56" [(ngModel)]="tableSearch"
                   placeholder="Rechercher" (keyup.enter)="onFilterChange()"/>
        </p-icon-field>
        <p-button icon="pi pi-refresh" severity="secondary" [loading]="loading" (onClick)="loadServers()"></p-button>
        <p-button icon="pi pi-play" label="Lancer" severity="success" (onClick)="openQuickLaunchDialog()"></p-button>
    </div>
</div>

<div *ngIf="loading" class="flex justify-center items-center py-8">
    <p-progressSpinner styleClass="w-12 h-12" strokeWidth="4" fill="var(--surface-ground)" animationDuration=".5s"/>
</div>

<div *ngIf="!loading" class="w-full overflow-hidden">
    <p-table
        [value]="servers"
        [rows]="paginationParams.size"
        [totalRecords]="totalRecords"
        [paginator]="true"
        [showCurrentPageReport]="true"
        currentPageReportTemplate="Page {currentPage} sur {totalPages} ({totalRecords} serveurs)"
        [globalFilterFields]="['id', 'minigame', 'map']"
        [(selection)]="selectedServer"
        [filterDelay]="0"
        [rowHover]="true"
        [lazy]="true"
        (onPage)="onPageChange($event)"
        emptyMessage="Aucun serveur trouvé"
    >
        <ng-template pTemplate="header">
            <tr>
                <th>ID / Serveur</th>
                <th>Mini-jeu</th>
                <th>Map</th>
                <th>Uptime</th>
                <th>RAM</th>
                <th>CPU</th>
                <th>TPS</th>
                <th>Joueurs</th>
                <th style="width: 150px">Actions</th>
            </tr>
        </ng-template>
        <ng-template pTemplate="body" let-server>
            <tr [pSelectableRow]="server">
                <td style="max-width: 150px; min-width: 150px;">
                    <div class="flex flex-col">
                        <div class="flex items-center gap-2">
                            <p-tag
                                [severity]="getStatusSeverity(server.status)"
                                [value]="getStatusDisplay(server.status)"
                                [styleClass]="'!px-1.5 !py-1 !text-xs'"
                            ></p-tag>
                            <span class="label-xsmall text-surface-950 dark:text-surface-0">{{ server.id }}</span>
                        </div>
                        <div class="text-xs text-surface-500 dark:text-surface-400 mt-1 truncate">
                            {{ server.containerId }}
                        </div>
                    </div>
                </td>
                <td>
                    <div class="flex items-center">
                        <p-avatar
                            [label]="getInitials(server.minigame)"
                            styleClass="mr-2 !w-7 !h-7 !text-xs font-medium flex-shrink-0"
                            [style]="{ backgroundColor: 'var(--p-' + server.color + '-100)', color: 'var(--p-' + server.color + '-950)' }"
                            shape="circle"
                        />
                        <span class="label-xsmall text-surface-950 dark:text-surface-0">{{ server.minigame }}</span>
                    </div>
                </td>
                <td>
                    <div class="label-xsmall text-left text-surface-950 dark:text-surface-0">
                        {{ server.map }}
                    </div>
                </td>
                <td>
                    <div class="label-xsmall text-left text-surface-950 dark:text-surface-0">
                        {{ getUptime(server.startedAt) }}
                    </div>
                </td>
                <td style="width: 120px;">
                    <div>
                        <div class="flex justify-between text-xs mb-1">
                            <span>{{ (server.resources.ram.usage * server.resources.ram.total).toFixed(1) }}
                                / {{ server.resources.ram.total }} GB</span>
                        </div>
                        <p-progressBar
                            [value]="server.resources.ram.usage * 100"
                            [showValue]="false"
                            [style]="{'height': '5px'}"
                            [styleClass]="'!rounded-full ' + getRamStatusClass(server.resources.ram.usage)"
                        />
                    </div>
                </td>
                <td style="width: 120px;">
                    <div>
                        <div class="flex justify-between text-xs mb-1">
                            <span>{{ server.resources.cpu.toFixed(1) }}%</span>
                        </div>
                        <p-progressBar
                            [value]="server.resources.cpu"
                            [showValue]="false"
                            [style]="{'height': '5px'}"
                            [styleClass]="'!rounded-full ' + getCpuStatusClass(server.resources.cpu)"
                        />
                    </div>
                </td>
                <td>
                    <p-tag
                        [severity]="getTpsSeverity(server.tps)"
                        [value]="server.tps.toFixed(1)"
                        styleClass="!px-2 !py-1 !rounded-lg"
                        pTooltip="TPS optimal: 20"
                    />
                </td>
                <td>
                    <div class="flex items-center gap-2">
                        <span class="body-xsmall">{{ server.players.current }}/{{ server.players.max }}</span>
                        <p-progressBar
                            [value]="(server.players.current / server.players.max) * 100"
                            [showValue]="false"
                            [style]="{'height': '5px', 'width': '50px'}"
                            styleClass="!rounded-full"
                        />
                    </div>
                </td>
                <td>
                    <div class="flex gap-2 items-center justify-end">
                        <p-button
                            icon="pi pi-info-circle"
                            severity="secondary"
                            size="small"
                            pTooltip="Détails"
                            tooltipPosition="top"
                            [routerLink]="['/servers', server.id]"
                        />
                        <p-button
                            icon="pi pi-power-off"
                            severity="danger"
                            size="small"
                            pTooltip="Arrêter"
                            tooltipPosition="top"
                            (onClick)="stopServer(server)"
                        />
                    </div>
                </td>
            </tr>
        </ng-template>
    </p-table>
</div>

<!-- Dialog de lancement rapide de serveur (simplifié) -->
<p-dialog
    header="Lancer un serveur"
    [(visible)]="quickLaunchDialogVisible"
    [style]="{width: '400px'}"
    [modal]="true"
    [draggable]="false"
    [resizable]="false"
    [closable]="!launchingServer"
>
    <div class="p-fluid">
        <div class="mb-3">
            <p class="text-sm">Sélectionnez le mini-jeu à lancer :</p>
        </div>

        <p-select
            appendTo="body"
            [options]="availableMinigames"
            [(ngModel)]="selectedMinigameToLaunch"
            placeholder="Sélectionner un mini-jeu"
            [disabled]="launchingServer"
            styleClass="w-full"
            optionLabel="label"
            optionValue="value"
        ></p-select>
    </div>

    <ng-template pTemplate="footer">
        <p-button
            label="Annuler"
            icon="pi pi-times"
            (onClick)="quickLaunchDialogVisible = false"
            [disabled]="launchingServer"
            styleClass="p-button-text"
        ></p-button>
        <p-button
            label="Lancer"
            icon="pi pi-play"
            (onClick)="launchServer()"
            [disabled]="!selectedMinigameToLaunch || launchingServer"
            [loading]="launchingServer"
            severity="success"
        ></p-button>
    </ng-template>
</p-dialog>
