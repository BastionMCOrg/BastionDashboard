<div class="flex lg:flex-row flex-col lg:items-center justify-between mb-4 w-full gap-6">
    <div class="flex-1">
        <div class="label-medium">Serveurs</div>
        <span class="mt-1 body-xsmall">Liste des serveurs actifs de BastionMC</span>
    </div>
    <div class="flex flex-wrap items-center gap-3.5">
        <p-dropdown
            *ngIf="!minigameFilter"
            [options]="minigameFilters"
            [(ngModel)]="selectedMinigameFilter"
            optionLabel="name"
            placeholder="Tous les mini-jeux"
            styleClass="w-48"
            (onChange)="filterServers()"
        >
            <ng-template pTemplate="selectedItem">
                <div class="flex items-center gap-2" *ngIf="selectedMinigameFilter">
                    <div
                        class="w-3 h-3 rounded-full"
                        [style.background-color]="'var(--p-' + (selectedMinigameFilter.color || 'blue') + '-500)'"
                    ></div>
                    <div>{{ selectedMinigameFilter.name }}</div>
                </div>
            </ng-template>
            <ng-template let-minigame pTemplate="item">
                <div class="flex items-center gap-2">
                    <div
                        class="w-3 h-3 rounded-full"
                        [style.background-color]="'var(--p-' + (minigame.color || 'blue') + '-500)'"
                    ></div>
                    <div>{{ minigame.name }}</div>
                </div>
            </ng-template>
        </p-dropdown>
        <p-icon-field>
            <p-inputicon class="pi pi-search"/>
            <input pInputText class="!rounded-lg !py-1.5 !w-56" [(ngModel)]="tableSearch"
                   placeholder="Rechercher" (input)="filterServers()"/>
        </p-icon-field>
    </div>
</div>
<div class="w-full overflow-hidden">
    <p-table
        [value]="filteredServers"
        [rows]="7"
        [paginator]="true"
        [showCurrentPageReport]="true"
        currentPageReportTemplate="Page {currentPage} sur {totalPages}"
        [globalFilterFields]="['id', 'minigame', 'map']"
        [(selection)]="selectedServer"
        [filterDelay]="0"
        [rowHover]="true"
    >
        <ng-template pTemplate="header">
            <tr>
                <th>ID / Serveur</th>
                <th>Mini-jeu</th>
                <th>Map</th>
                <th>Uptime</th>
                <th>RAM</th>
                <th>CPU</th>
                <th>TPS</th>
                <th>Joueurs</th>
                <th style="width: 150px">Actions</th>
            </tr>
        </ng-template>
        <ng-template pTemplate="body" let-server>
            <tr [pSelectableRow]="server">
                <td style="max-width: 150px; min-width: 150px;">
                    <div class="flex flex-col">
                        <div class="flex items-center gap-2">
                            <p-tag
                                [severity]="$any(getStatusSeverity(server.status))"
                                [value]="getStatusDisplay(server.status)"
                                [styleClass]="'!px-1.5 !py-1 !text-xs'"
                            ></p-tag>
                            <span class="label-xsmall text-surface-950 dark:text-surface-0">{{ server.id }}</span>
                        </div>
                        <div class="text-xs text-surface-500 dark:text-surface-400 mt-1 truncate"
                             [pTooltip]="server.containerId" tooltipPosition="top">
                            {{ server.containerId }}
                        </div>
                    </div>
                </td>
                <td>
                    <div class="flex items-center">
                        <p-avatar
                            [label]="getInitials(server.minigame)"
                            styleClass="mr-2 !w-7 !h-7 !text-xs font-medium flex-shrink-0"
                            [style]="{ backgroundColor: 'var(--p-' + server.color + '-100)', color: 'var(--p-' + server.color + '-950)' }"
                            shape="circle"
                        />
                        <span class="label-xsmall text-surface-950 dark:text-surface-0">{{ server.minigame }}</span>
                    </div>
                </td>
                <td>
                    <div class="label-xsmall text-left text-surface-950 dark:text-surface-0">
                        {{ server.map }}
                    </div>
                </td>
                <td>
                    <div class="label-xsmall text-left text-surface-950 dark:text-surface-0">
                        {{ getUptime(server.startedAt) }}
                    </div>
                </td>
                <td style="width: 120px;">
                    <div>
                        <div class="flex justify-between text-xs mb-1">
                            <span>{{ (server.resources.ram.usage * server.resources.ram.total).toFixed(1) }} / {{ server.resources.ram.total }} GB</span>
                        </div>
                        <p-progressBar
                            [value]="server.resources.ram.usage * 100"
                            [showValue]="false"
                            [style]="{'height': '5px'}"
                            [styleClass]="'!rounded-full ' + getRamStatusClass(server.resources.ram.usage)"
                        />
                    </div>
                </td>
                <td style="width: 120px;">
                    <div>
                        <div class="flex justify-between text-xs mb-1">
                            <span>{{ server.resources.cpu.toFixed(1) }}%</span>
                        </div>
                        <p-progressBar
                            [value]="server.resources.cpu"
                            [showValue]="false"
                            [style]="{'height': '5px'}"
                            [styleClass]="'!rounded-full ' + getCpuStatusClass(server.resources.cpu)"
                        />
                    </div>
                </td>
                <td>
                    <p-tag
                        [severity]="$any(getTpsSeverity(server.tps))"
                        [value]="server.tps.toFixed(1)"
                        styleClass="!px-2 !py-1 !rounded-lg"
                        pTooltip="TPS optimal: 20"
                    />
                </td>
                <td>
                    <div class="flex items-center gap-2">
                        <span class="body-xsmall">{{ server.players.current }}/{{ server.players.max }}</span>
                        <p-progressBar
                            [value]="(server.players.current / server.players.max) * 100"
                            [showValue]="false"
                            [style]="{'height': '5px', 'width': '50px'}"
                            styleClass="!rounded-full"
                        />
                    </div>
                </td>
                <td>
                    <div class="flex gap-2 items-center justify-end">
                        <p-button
                            icon="pi pi-align-justify"
                            severity="info"
                            size="small"
                            pTooltip="Voir les logs"
                            tooltipPosition="top"
                            (onClick)="viewLogs(server)"
                        />
                        <p-button
                            icon="pi pi-info-circle"
                            severity="secondary"
                            size="small"
                            pTooltip="Détails"
                            tooltipPosition="top"
                        />
                        <p-button
                            icon="pi pi-power-off"
                            severity="danger"
                            size="small"
                            pTooltip="Arrêter"
                            tooltipPosition="top"
                        />
                    </div>
                </td>
            </tr>
        </ng-template>
    </p-table>
</div>

<!-- Dialog des logs -->
<p-dialog
    header="Logs du serveur"
    [(visible)]="logsDialogVisible"
    [style]="{width: '70vw'}"
    [modal]="true"
    [draggable]="false"
    [resizable]="false"
>
    <div class="w-full p-3 bg-surface-900 text-surface-0 font-mono text-sm h-96 overflow-auto rounded-md">
        <div *ngFor="let line of serverLogs" class="whitespace-pre-wrap mb-1">
            <ng-container [ngSwitch]="getLogLevel(line)">
                <span *ngSwitchCase="'error'" class="text-red-500">[ERROR] {{ line }}</span>
                <span *ngSwitchCase="'warn'" class="text-yellow-500">[WARN] {{ line }}</span>
                <span *ngSwitchCase="'info'" class="text-blue-500">[INFO] {{ line }}</span>
                <span *ngSwitchDefault>{{ line }}</span>
            </ng-container>
        </div>
    </div>
    <div class="flex justify-end mt-4">
        <p-button label="Fermer" icon="pi pi-times" (onClick)="logsDialogVisible = false"></p-button>
    </div>
</p-dialog>
